<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>영상 / 음성 노멀라이즈 실험실 – FreeComfortLab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="영상과 음성 파일의 음량을 일정하게 맞춰주는 노멀라이즈 실험 페이지입니다. mp4, mkv, mov, mp3, wav 파일을 업로드하면 자동으로 처리합니다.">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header a {
      color: #e5e7eb;
      text-decoration: none;
      font-size: 14px;
      opacity: .8;
    }
    header a:hover {
      opacity: 1;
    }
    .container {
      max-width: 720px;
      margin: 32px auto;
      padding: 0 16px 48px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }
    p.desc {
      font-size: 14px;
      color: #9ca3af;
      line-height: 1.5;
      margin-bottom: 24px;
    }
    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 20px 20px 24px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
    }
    .field {
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      color: #cbd5f5;
    }
    input[type="file"] {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.7);
      color: #e5e7eb;
      font-size: 13px;
    }
    .mode-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
    }
    select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      box-shadow: 0 10px 30px rgba(34, 197, 94, 0.35);
      transition: transform .08s ease-out, box-shadow .08s ease-out, opacity .08s;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(34, 197, 94, 0.45);
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }
    .status-box {
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.6;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      white-space: pre-wrap;
      word-break: break-all;
    }
    .status-box.ok {
      border-color: rgba(52, 211, 153, 0.8);
    }
    .status-box.err {
      border-color: rgba(248, 113, 113, 0.8);
    }
    .download-link {
      margin-top: 16px;
      font-size: 13px;
    }
    .download-link a {
      color: #4ade80;
      text-decoration: none;
    }
    .download-link a:hover {
      text-decoration: underline;
    }
    small {
      font-size: 11px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <header>
    <a href="/">&larr; FreeComfortLab 메인으로</a>
    <span style="font-size:12px; color:#9ca3af;">영상/음성 노멀라이즈 실험</span>
  </header>

  <div class="container">
    <h1>영상 / 음성 노멀라이즈 실험실</h1>
    <p class="desc">
      mp4 / mkv / mov / mp3 / wav 파일을 업로드하면,<br>
      ffmpeg의 <code>loudnorm</code> 필터를 사용해서 음량을 일정하게 맞춰주는 실험용 도구입니다.<br>
      아직은 테스트 단계라, 중요한 파일은 백업 후 사용해 주세요.
    </p>

    <div class="card">
      <div class="field">
        <label for="fileInput">파일 선택</label>
        <input id="fileInput" type="file" accept="video/*,audio/*">
      </div>

      <div class="field">
        <label>모드 선택</label>
        <div class="mode-row">
          <select id="modeSelect">
            <option value="video">영상 유지 + 오디오 노멀라이즈 (mp4)</option>
            <option value="audio">오디오만 추출 + 노멀라이즈 (mp3)</option>
          </select>
        </div>
        <small>
          • 영상 모드: 기존 비디오는 그대로 두고 오디오만 정규화한 mp4 반환<br>
          • 오디오 모드: 오디오만 추출하여 정규화된 mp3 파일로 반환
        </small>
      </div>

      <div class="field">
        <button id="runBtn">
          <span id="btnLabel">노멀라이즈 시작</span>
        </button>
      </div>

      <div id="statusBox" class="status-box">
        아직 요청 전입니다. 파일을 선택하고 "노멀라이즈 시작" 버튼을 눌러 주세요.
      </div>

      <div id="downloadArea" class="download-link" style="display:none;"></div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const modeSelect = document.getElementById("modeSelect");
    const runBtn = document.getElementById("runBtn");
    const btnLabel = document.getElementById("btnLabel");
    const statusBox = document.getElementById("statusBox");
    const downloadArea = document.getElementById("downloadArea");

    function setStatus(message, type) {
      statusBox.textContent = message;
      statusBox.classList.remove("ok", "err");
      if (type === "ok") statusBox.classList.add("ok");
      if (type === "err") statusBox.classList.add("err");
    }

    async function handleNormalize() {
      const file = fileInput.files[0];
      const mode = modeSelect.value;

      if (!file) {
        setStatus("먼저 업로드할 파일을 선택해 주세요.", "err");
        return;
      }

      runBtn.disabled = true;
      btnLabel.textContent = "처리 중...";
      setStatus("서버로 파일을 전송하고 있습니다...\n이 작업은 파일 크기에 따라 시간이 걸릴 수 있습니다.", null);
      downloadArea.style.display = "none";
      downloadArea.innerHTML = "";

      try {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("mode", mode);

        const res = await fetch("/api/video-normalize", {
          method: "POST",
          body: formData,
        });

        const contentType = res.headers.get("Content-Type") || "";

        if (!res.ok) {
          // 에러일 경우 JSON일 확률 높음
          let msg = `HTTP ${res.status}`;
          try {
            if (contentType.includes("application/json")) {
              const data = await res.json();
              msg += `\nstatus: ${data.status}\nmessage: ${data.message || ""}\n${data.detail || ""}`;
            } else {
              const text = await res.text();
              msg += `\n${text}`;
            }
          } catch (e) {
            // 무시
          }
          setStatus("요청 실행 중 오류가 발생했습니다.\n\n" + msg, "err");
          return;
        }

        // 성공일 경우: 바이너리(blob) 응답으로 파일 내려줌
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        // 파일명 추출
        let filename = "normalized_output";
        const dispo = res.headers.get("Content-Disposition") || "";
        const match = dispo.match(/filename="?([^"]+)"?/);
        if (match && match[1]) {
          filename = decodeURIComponent(match[1]);
        }

        downloadArea.innerHTML = `
          변환이 완료되었습니다. 아래 링크를 눌러 파일을 다운로드하세요.<br>
          <a href="\${url}" download="\${filename}">\${filename}</a>
        `;
        downloadArea.style.display = "block";
        setStatus("정상적으로 처리되었습니다. 이제 결과 파일을 다운로드할 수 있습니다.", "ok");
      } catch (err) {
        console.error(err);
        setStatus("요청 처리 중 알 수 없는 오류가 발생했습니다.\n" + err, "err");
      } finally {
        runBtn.disabled = false;
        btnLabel.textContent = "노멀라이즈 시작";
      }
    }

    runBtn.addEventListener("click", handleNormalize);
  </script>
</body>
</html>
