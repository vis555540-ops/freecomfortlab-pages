<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>오디오 / 카카오톡 영상 변환 – FreeComfortLab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="오디오는 mp3로, 카카오톡 영상은 보기 편한 mp4로 정리해 주는 실험실입니다.">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header a {
      color: #e5e7eb;
      text-decoration: none;
      font-size: 14px;
      opacity: .8;
    }
    header a:hover {
      opacity: 1;
    }
    .mode-label {
      font-size: 11px;
      color: #9ca3af;
      margin-right: 8px;
    }
    .mode-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .switch-label {
      font-size: 11px;
      color: #9ca3af;
      transition: color .12s ease-out;
    }
    .switch-label.active-audio {
      color: #38bdf8;
      font-weight: 600;
    }
    .switch-label.active-video {
      color: #facc15;
      font-weight: 600;
    }
    .switch-btn {
      position: relative;
      width: 40px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #020617;
      cursor: pointer;
      padding: 0;
      outline: none;
      display: inline-flex;
      align-items: center;
      transition: background .12s ease-out, border-color .12s ease-out;
    }
    .switch-knob {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-left: 2px;
      transition: transform .12s ease-out, background .12s ease-out;
    }
    body.mode-video .switch-btn {
      background: #facc15;
      border-color: #facc15;
    }
    body.mode-video .switch-knob {
      transform: translateX(18px);
      background: #111827;
    }

    .container {
      max-width: 800px;
      margin: 32px auto;
      padding: 0 16px 48px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }
    .subtitle {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }
    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.18), transparent 55%),
                  radial-gradient(circle at top right, rgba(250,204,21,0.18), transparent 55%),
                  #020617;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      padding: 20px 20px 24px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.95);
    }
    .field {
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      color: #cbd5f5;
    }
    input[type="file"] {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed rgba(148, 163, 184, 0.85);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 13px;
    }
    .hint {
      font-size: 11px;
      color: #9ca3af;
      line-height: 1.5;
    }
    .hint strong {
      color: #e5e7eb;
    }
    button.action {
      margin-top: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #0b1120;
      box-shadow: 0 12px 35px rgba(56,189,248,0.45);
      transition: transform .08s ease-out, box-shadow .08s ease-out, opacity .08s;
    }
    body.mode-video button.action {
      background: linear-gradient(135deg, #facc15, #eab308);
      box-shadow: 0 12px 35px rgba(250,204,21,0.5);
      color: #1f2937;
    }
    button.action:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 45px rgba(56,189,248,0.6);
    }
    body.mode-video button.action:hover {
      box-shadow: 0 18px 45px rgba(250,204,21,0.7);
    }
    button.action:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }
    .status-box {
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.6;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.55);
      white-space: pre-wrap;
      word-break: break-all;
    }
    .status-box.ok {
      border-color: rgba(52, 211, 153, 0.85);
    }
    .status-box.err {
      border-color: rgba(248, 113, 113, 0.9);
    }
    .download-link {
      margin-top: 16px;
      font-size: 13px;
    }
    .download-link a {
      color: #4ade80;
      text-decoration: none;
    }
    .download-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body class="mode-audio">
  <header>
    <a href="/">&larr; FreeComfortLab 메인으로</a>
    <div class="mode-toggle">
      <span id="labelAudio" class="switch-label active-audio">오디오 변환</span>
      <button id="modeSwitch" class="switch-btn" type="button" aria-label="모드 전환">
        <div class="switch-knob"></div>
      </button>
      <span id="labelVideo" class="switch-label">카카오톡 영상 변환</span>
    </div>
  </header>

  <div class="container">
    <div class="pill">
      <span class="dot"></span>
      <span id="pillText">현재: 오디오 → mp3 변환 모드</span>
    </div>

    <h1 id="titleText">오디오 / 카카오톡 영상 변환 실험실</h1>
    <p class="subtitle" id="descText">
      위 스위치로 모드를 바꿀 수 있습니다.<br>
      기본은 <strong>오디오 파일을 mp3로 변환</strong>하는 모드이며,<br>
      스위치를 오른쪽으로 켜면 <strong>카카오톡으로 받은 영상 정리용 모드</strong>로 바뀝니다.
    </p>

    <div class="card">
      <div class="field">
        <label for="fileInput" id="fileLabel">파일 선택 (오디오 파일)</label>
        <input id="fileInput" type="file" accept="audio/*">
      </div>
      <div class="field">
        <p class="hint" id="hintText">
          • 오디오 모드: 녹음, mp4에서 추출한 음원 등 대부분의 음성 파일을 <strong>mp3</strong>로 변환합니다.<br>
          • 변환된 mp3는 다운로드 받아서 보관/편집에 사용할 수 있습니다.
        </p>
      </div>

      <button id="runBtn" class="action" type="button">
        <span id="btnText">오디오 mp3로 변환 시작</span>
      </button>

      <div id="statusBox" class="status-box">
        아직 요청 전입니다. 파일을 선택하고 버튼을 눌러 주세요.
      </div>

      <div id="downloadArea" class="download-link" style="display:none;"></div>
    </div>
  </div>

  <script>
    const body = document.body;
    const modeSwitch = document.getElementById("modeSwitch");
    const labelAudio = document.getElementById("labelAudio");
    const labelVideo = document.getElementById("labelVideo");
    const pillText = document.getElementById("pillText");
    const titleText = document.getElementById("titleText");
    const descText = document.getElementById("descText");
    const fileLabel = document.getElementById("fileLabel");
    const fileInput = document.getElementById("fileInput");
    const hintText = document.getElementById("hintText");
    const runBtn = document.getElementById("runBtn");
    const btnText = document.getElementById("btnText");
    const statusBox = document.getElementById("statusBox");
    const downloadArea = document.getElementById("downloadArea");

    let currentMode = "audio"; // "audio" | "video"

    function setStatus(message, type) {
      statusBox.textContent = message;
      statusBox.classList.remove("ok", "err");
      if (type === "ok") statusBox.classList.add("ok");
      if (type === "err") statusBox.classList.add("err");
    }

    function updateModeUI() {
      if (currentMode === "audio") {
        body.classList.remove("mode-video");
        body.classList.add("mode-audio");

        labelAudio.classList.add("active-audio");
        labelVideo.classList.remove("active-video");

        pillText.textContent = "현재: 오디오 → mp3 변환 모드";
        titleText.textContent = "오디오 변환 실험실";
        descText.innerHTML =
          "녹음 파일, 음성 추출 파일 등을 <strong>mp3</strong>로 정리하는 실험 모드입니다.<br>" +
          "카카오톡 영상이 아니라, 순수 오디오 위주로 정리할 때 사용해 주세요.";

        fileLabel.textContent = "파일 선택 (오디오 파일)";
        fileInput.accept = "audio/*";

        hintText.innerHTML =
          "• mp3, wav, m4a, mp4의 오디오 등 대부분의 음성 파일을 mp3로 변환합니다.<br>" +
          "• 결과 파일은 mp3 형식으로 다운로드됩니다.";

        btnText.textContent = "오디오 mp3로 변환 시작";
      } else {
        body.classList.remove("mode-audio");
        body.classList.add("mode-video");

        labelAudio.classList.remove("active-audio");
        labelVideo.classList.add("active-video");

        pillText.textContent = "현재: 카카오톡 영상 변환 모드";
        titleText.textContent = "카카오톡 영상 정리 실험실";
        descText.innerHTML =
          "카카오톡으로 받은 세로 영상, 가로 영상 등을 <strong>보기 편한 mp4</strong>로 정리하는 모드입니다.<br>" +
          "음량도 함께 맞춰서, 볼 때마다 볼륨 조절할 필요를 줄여줍니다.";

        fileLabel.textContent = "파일 선택 (카카오톡 영상 파일)";
        fileInput.accept = "video/*";

        hintText.innerHTML =
          "• mp4, mkv, mov 등 대부분의 영상 파일을 입력할 수 있습니다.<br>" +
          "• 결과 파일은 mp4 형식으로 다운로드되며, 음량은 loudnorm으로 자동 정규화합니다.";

        btnText.textContent = "카카오톡 영상 변환 시작";
      }

      downloadArea.style.display = "none";
      downloadArea.innerHTML = "";
      setStatus("파일을 선택한 뒤 버튼을 눌러 주세요.", null);
    }

    modeSwitch.addEventListener("click", () => {
      currentMode = currentMode === "audio" ? "video" : "audio";
      updateModeUI();
    });

    async function handleRun() {
      const file = fileInput.files[0];

      if (!file) {
        setStatus("먼저 업로드할 파일을 선택해 주세요.", "err");
        return;
      }

      runBtn.disabled = true;
      setStatus("서버로 파일을 전송하고 있습니다...\n파일 크기에 따라 시간이 걸릴 수 있습니다.", null);
      downloadArea.style.display = "none";
      downloadArea.innerHTML = "";

      try {
        const formData = new FormData();
        formData.append("file", file);

        let endpoint = "";
        if (currentMode === "audio") {
          endpoint = "/api/convert";
          formData.append("format", "mp3");
        } else {
          endpoint = "/api/video-normalize";
          formData.append("mode", "video");
        }

        const res = await fetch(endpoint, {
          method: "POST",
          body: formData,
        });

        const contentType = res.headers.get("Content-Type") || "";

        if (!res.ok) {
          let msg = `HTTP ${res.status}`;
          try {
            if (contentType.includes("application/json")) {
              const data = await res.json();
              msg += `\nstatus: ${data.status}\nmessage: ${data.message || ""}\n${data.detail || ""}`;
            } else {
              const text = await res.text();
              msg += `\n${text}`;
            }
          } catch (e) {}
          setStatus("요청 실행 중 오류가 발생했습니다.\n\n" + msg, "err");
          return;
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        let filename = currentMode === "audio" ? "audio_normalized.mp3" : "video_normalized.mp4";
        const dispo = res.headers.get("Content-Disposition") || "";
        const match = dispo.match(/filename="?([^"]+)"?/);
        if (match && match[1]) {
          filename = decodeURIComponent(match[1]);
        }

        downloadArea.innerHTML = `
          변환이 완료되었습니다. 아래 링크를 눌러 파일을 다운로드하세요.<br>
          <a href="\${url}" download="\${filename}">\${filename}</a>
        `;
        downloadArea.style.display = "block";
        setStatus("정상적으로 처리되었습니다. 이제 결과 파일을 다운로드할 수 있습니다.", "ok");
      } catch (err) {
        console.error(err);
        setStatus("요청 처리 중 알 수 없는 오류가 발생했습니다.\n" + err, "err");
      } finally {
        runBtn.disabled = false;
      }
    }

    runBtn.addEventListener("click", handleRun);

    // 초기 UI 세팅
    updateModeUI();
  </script>
</body>
</html>
